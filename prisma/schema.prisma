generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // 소셜 로그인 연결
  accounts      Account[]
  sessions      Session[]

  profile       UserProfile?
  diagnoses     LevelDiagnosis[]
  quizAttempts  UserQuizAttempt[]
  vocabularies      UserVocabulary[]
  flashcardSessions FlashcardSession[]
}

model Account {
  id            String    @id
  userId        String
  providerId    String   
  accountId     String    
  accessToken   String?   @db.Text
  refreshToken  String?   @db.Text
  idToken       String?   @db.Text
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope         String?
  password      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Session {
  id            String    @id
  token         String    @unique
  expiresAt     DateTime 

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  ipAddress     String?
  userAgent     String?
  
  userId        String
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier])
  @@map("verification")
}

model UserProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  level           String    @default("A1")    // CEFR 레벨
  totalXP         Int       @default(0)
  lastStudyDate   DateTime?
  currentStreak   Int       @default(0)
  longestStreak   Int       @default(0)

  // 약점 영역 (JSON): {"동사": 45.5, "형용사": 30.0}
  weaknessAreas   Json?

  // 어휘 학습 통계
  totalWordLearned Int @default(0)
  masteredWords    Int @default(0)
  reviewNeeded     Int @default(0)

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
}

model QuizQuestion { // 퀴즈 질문
  id              String   @id @default(cuid())
  koreanHint      String   // 한글 힌트
  contextHintKo   String?  // 상황 설명 힌트 (한국어)
  englishWord     String   // 정답 영어 단어
  sentence        String   // 문맥 문장 (빈칸 포함)
  difficulty      String   // A1, A2, B1, B2, C1, C2
  category        String   // daily, business, toeic, travel, idioms

  options         QuizOption[]
  attempts        UserQuizAttempt[]

  createdAt       DateTime @default(now())

  @@index([difficulty, category])
}

model UserQuizAttempt {
  id              String   @id @default(cuid())
  userId          String
  questionId      String
  selectedAnswer  String
  isCorrect       Boolean
  timeSpent       Int      // 초 단위
  hintLevel       Int      @default(0)  // 0(없음), 1(상황), 2(전체)
  attemptedAt     DateTime @default(now())

  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  question        QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([userId, attemptedAt])
}

model WeaknessArea { // 약점 영역(카테고리별 정확도)
  id              String   @id @default(cuid())
  diagnosisId     String
  category        String   // 동사, 형용사, 명사 등(약점 영역)
  accuracy        Float    // 정확도 %

  diagnosis       LevelDiagnosis @relation(fields: [diagnosisId], references: [id], onDelete: Cascade)

  @@index([diagnosisId])
}

model LevelDiagnosis {
  id              String    @id @default(cuid())
  userId          String
  totalScore      Int       // 0-100
  cefrLevel       String    // A1, A2, B1, B2, C1, C2
  completedAt     DateTime  @default(now())

  weaknessAreas   WeaknessArea[]
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model QuizOption { // 퀴즈 문제의 선택지
  id              String   @id @default(cuid())
  questionId      String
  text            String
  isCorrect       Boolean
  order           Int      // 1-4

  question        QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
}

// 어휘 콘텐츠 모델
model Vocabulary {
  id              String   @id @default(cuid())
  word            String   @unique
  meaning         String
  pronunciation   String?
  exampleSentence String?
  category        String   // daily, business, toeic, travel
  level           String   // A1-C2
  audioUrl        String?
  userProgress    UserVocabulary[]
  createdAt       DateTime @default(now())

  @@index([level, category])
  @@map("vocabularies")
}

// 사용자 어휘 진행 상황 (SRS 핵심)
model UserVocabulary {
  id              String   @id @default(cuid())
  userId          String
  vocabularyId    String
  masteryLevel    String   @default("new")
  repetitions     Int      @default(0)
  easeFactor      Float    @default(2.5)
  interval        Int      @default(1)
  lastReviewDate  DateTime?
  nextReviewDate  DateTime @default(now())
  totalReviews    Int      @default(0)
  correctCount    Int      @default(0)
  incorrectCount  Int      @default(0)
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  vocabulary      Vocabulary @relation(fields: [vocabularyId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([userId, vocabularyId])
  @@index([userId, nextReviewDate])
  @@index([userId, masteryLevel])
  @@map("user_vocabularies")
}

// 플래시카드 세션 추적
model FlashcardSession {
  id              String   @id @default(cuid())
  userId          String
  mode            String
  vocabularyCount Int
  accuracy        Float
  duration        Int
  easyCount       Int      @default(0)
  normalCount     Int      @default(0)
  hardCount       Int      @default(0)
  forgotCount     Int      @default(0)
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt       DateTime @default(now())

  @@index([userId, createdAt])
  @@map("flashcard_sessions")
}